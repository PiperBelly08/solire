{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Solire</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">

    {# Normalize #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css">

    {# Bootstrap #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous" defer></script>

    {# Custom CSS #}
    <link rel="stylesheet" href="{% static 'solire_app/style.css' %}">

    {# Icons #}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

    {# jQuery #}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    {# DataTables #}
    <link href="https://cdn.datatables.net/v/bs5/jq-3.7.0/jszip-3.10.1/dt-2.3.0/b-3.2.3/b-colvis-3.2.3/b-html5-3.2.3/b-print-3.2.3/cr-2.1.0/fh-4.0.1/r-3.0.4/sp-2.3.3/datatables.min.css" rel="stylesheet" integrity="sha384-uUny8v9vS7zUmrN8wyjZ51nK0Zj865io7DkkcwejIQYRPkWT0k42ulr2Qa/MqVlN" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js" integrity="sha384-VFQrHzqBh5qiJIU0uGU5CIW3+OWpdGGJM9LBnGbuIH2mkICcFZ7lPd/AAtI7SNf7" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js" integrity="sha384-/RlQG9uf0M2vcTw3CX7fbqgbj/h8wKxw7C3zu9/GxcBPRKOEcESxaxufwRXqzq6n" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/v/bs5/jq-3.7.0/jszip-3.10.1/dt-2.3.0/b-3.2.3/b-colvis-3.2.3/b-html5-3.2.3/b-print-3.2.3/cr-2.1.0/fh-4.0.1/r-3.0.4/sp-2.3.3/datatables.min.js" integrity="sha384-mHQpk6uc59YtrJgGnk80iRWjB9d8EGpFasFvDLoxTxqEmcnHlCz5zsxkLX3o0vCV" crossorigin="anonymous"></script>

    {# MQTT #}
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    {# Chart.js #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.9/dist/chart.umd.min.js"></script>
    {# REMOVED: Chart.js Annotation Plugin script tag to fix ReferenceError #}

    {# Font Inter #}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif; /* Apply Inter font globally */
        }
        /* Styles from interactive-analysis.html adapted for the simulator section */
        .chart-container {
            position: relative;
            width: 100%;
            height: 250px;
            max-height: 250px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 300px;
                max-height: 300px;
            }
        }
        /* Replaced Tailwind classes with custom styles for simulator components */
        .simulator-card { /* Replaces .card .rounded-lg .p-6 .space-y-6 etc. */
            background-color: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .simulator-input-group label { /* Replaces block, font-medium, text-gray-700 */
            display: block;
            font-weight: 500;
            color: #4B5563; /* text-gray-700 */
        }
        .simulator-input-group input[type="range"] { /* Replaces w-full, h-2, bg-gray-200, rounded-lg, appearance-none, cursor-pointer, slider-track */
            width: 100%;
            height: 0.5rem;
            background-color: #E5E7EB; /* bg-gray-200 */
            border-radius: 0.5rem; /* rounded-lg (approx) */
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }
        .simulator-input-group input[type="range"]::-webkit-slider-thumb { /* Custom thumb style */
            -webkit-appearance: none;
            appearance: none;
            width: 1rem;
            height: 1rem;
            background: #4A552A; /* Match Chart.js line color */
            border-radius: 50%;
            cursor: grab;
            margin-top: -0.25rem; /* Adjust to center thumb on track */
        }
        .simulator-input-group input[type="range"]::-moz-range-thumb { /* Custom thumb style for Firefox */
            width: 1rem;
            height: 1rem;
            background: #4A552A;
            border-radius: 50%;
            cursor: grab;
        }
        .simulator-text-value { /* For spans displaying slider values */
            font-weight: 700;
            color: #4A552A;
        }
        .active-rules-box { /* Replaces mt-2, text-sm, space-y-1, h-24, overflow-y-auto, bg-gray-50, p-2, rounded */
            margin-top: 0.5rem;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem; /* space-y-1 equivalent */
            height: 6rem; /* h-24 (96px = 6rem) */
            overflow-y: auto;
            background-color: #F9FAFB; /* bg-gray-50 */
            padding: 0.5rem; /* p-2 */
            border-radius: 0.25rem; /* rounded */
            color: #4B5563; /* Default text color */
        }
        .recommendation-box { /* Replaces text-center, bg-[#F0F2E6], p-8, rounded-lg */
            text-align: center;
            background-color: #F0F2E6;
            padding: 2rem; /* p-8 */
            border-radius: 0.5rem; /* rounded-lg */
        }
        .recommendation-output-text { /* Replaces text-4xl, font-bold, text-[#4A552A] */
            font-size: 2.25rem; /* text-4xl */
            line-height: 2.5rem;
            font-weight: 700;
            color: #4A552A;
        }
        .confidence-output-text { /* Replaces text-3xl, font-bold, text-green-600 */
            font-size: 1.875rem; /* text-3xl */
            line-height: 2.25rem;
            font-weight: 700;
            color: #22C55E; /* text-green-600 */
        }
    </style>
</head>
<body class="bg-slate-800">
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <i class="bi bi-speedometer2 text-white fs-4"></i>
            <h4>SolireWeb</h4>
        </div>
        <ul class="sidebar-nav nav nav-pills flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="">
                    <i class="bi bi-house-door"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#database-section">
                    <i class="bi bi-database"></i>
                    <span>Database</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#simulator-section">
                    <i class="bi bi-graph-up"></i>
                    <span>Simulator</span>
                </a>
            </li>
        </ul>
    </nav>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="main-content" id="mainContent">
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="container-fluid">
                <button class="toggle-btn" id="toggleSidebar">
                    <i class="bi bi-list"></i>
                </button>

                <div class="d-flex align-items-center gap-3 ms-auto">
                    <div class="d-none d-md-block invisible">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Search...">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="dropdown invisible">
                        <button class="btn btn-link text-decoration-none position-relative" data-bs-toggle="dropdown">
                            <i class="bi bi-bell fs-5 text-muted"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem;">3</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header">Notifications</h6></li>
                            <li><a class="dropdown-item" href="#">New user registered</a></li>
                            <li><a class="dropdown-item" href="#">Order #1234 completed</a></li>
                            <li><a class="dropdown-item" href="#">Server maintenance scheduled</a></li>
                        </ul>
                    </div>

                    <div class="dropdown profile-dropdown invisible">
                        <button class="btn btn-link text-decoration-none d-flex align-items-center gap-2" data-bs-toggle="dropdown">
                            <div class="user-avatar">JD</div>
                            <span class="d-none d-md-inline text-muted">John Doe</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header">john.doe@example.com</h6></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Profile</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <div class="content-wrapper">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Dashboard</h1>
                <button class="btn btn-primary invisible">
                    <i class="bi bi-plus-circle me-2"></i>Add New
                </button>
            </div>

            <div class="row mb-4">
                <div class="col-md-6 mb-4">
                    <div class="card stats-card h-100 w-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-2 text-white-50">Recommended Plant(s)</h6>
                                    <p class="stat-number">N/A</p>
                                </div>
                                <i class="bi bi-flower3 fs-1 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card stats-card h-100 w-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-2 text-white-50">Percentages</h6>
                                    <p class="stat-number"><span id="dashboard_percentages">0</span></p>
                                </div>
                                <i class="bi bi-percent fs-1 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4 col-md-6 mb-4">
                    <div class="card stats-card blue h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-2 text-white-50">PH</h6>
                                    <p class="stat-number"><span id="realtime_ph">0</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4 col-md-6 mb-4">
                    <div class="card stats-card green h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-2 text-white-50">Moisture</h6>
                                    <p class="stat-number"><span id="realtime_moisture">0</span></p>
                                </div>
                                <i class="bi bi-percent fs-1 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4 col-md-6 mb-4">
                    <div class="card stats-card yellow h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-2 text-white-50">Temperature</h6>
                                    <p class="stat-number"><span id="realtime_temperature">0</span>°C</p>
                                </div>
                                <i class="bi bi-thermometer fs-1 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-header bg-white">
                            <h5 class="card-title mb-0">Live Feed</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table mb-0" id="liveFeedTable">
                                    <thead>
                                        <tr>
                                            <th>PH</th>
                                            <th>Moisture</th>
                                            <th>Temperature</th>
                                            <th>Timestamps</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <hr>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0" id="database-section">Database</h1>
                <button class="btn btn-primary invisible">
                    <i class="bi bi-plus-circle me-2"></i>Add New
                </button>
            </div>

            <div class="row">
                <div class="col-lg-8 mb-4">
                    <div class="card">
                        <div class="card-header bg-white">
                            <h5 class="card-title mb-0">Database</h5>
                        </div>
                        <div class="card-body p-0 my-3">
                            <div class="table-responsive">
                                <table class="table mb-0" id="soilConditionsTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>PH</th>
                                            <th>Moisture</th>
                                            <th>Temperature</th>
                                            <th>Recommended Plants</th>
                                            <th>Timestamps</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 mb-4">
                    <div class="card">
                        <div class="card-header bg-white">
                            <h5 class="card-title mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="{%  url 'solire_app:generate_report' %}" class="btn btn-outline-info">
                                    <i class="bi bi-file-earmark-text me-2"></i>Generate Report
                                </a>
                                <button class="btn btn-outline-primary" id="refreshDatabase">
                                    <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                                </button>
                                <button class="btn btn-outline-danger" id="clearDatabase">
                                    <i class="bi bi-trash me-2"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <hr>

            <section id="simulator-section" class="page-section mb-16 scroll-mt-20">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">Simulator</h1>
                    <button class="btn btn-primary invisible">
                        <i class="bi bi-plus-circle me-2"></i>Add New
                    </button>
                </div>
<!--                <p class="text-center text-lg text-secondary max-w-3xl mx-auto mb-4">-->
<!--                    This is a tool to understand the "black box" of your Mamdani Fuzzy system. Slide the inputs to change sensor values and see in real-time how the system processes them: from fuzzification, rule evaluation, to generating concrete plant recommendations through defuzzification.-->
<!--                </p>-->
                <div class="row lg-4"> {# Replaced grid lg:grid-cols-3 gap-8 with Bootstrap row and gutter #}
                    <div class="col-lg-4"> {# Replaced lg:col-span-1 #}
                        <div class="simulator-card space-y-4"> {# Replaced Tailwind classes #}
                            <h3 class="h5 font-weight-bold">Input</h3> {# Replaced text-xl font-bold #}
                            <div class="simulator-input-group">
                                <label for="ph-slider" class="simulator-input-group-label">Soil pH: <span id="ph-value" class="simulator-text-value"></span></label>
                                <input id="ph-slider" type="range" min="0" max="14" value="0" step="0.1" class="simulator-input-group-range">
                            </div>
                            <div class="simulator-input-group">
                                <label for="temp-slider" class="simulator-input-group-label">Temperature (°C): <span id="temp-value" class="simulator-text-value">0</span></label>
                                <input id="temp-slider" type="range" min="0" max="40" value="0" step="1" class="simulator-input-group-range">
                            </div>
                            <div class="simulator-input-group">
                                <label for="moisture-slider" class="simulator-input-group-label">Moisture (%): <span id="moisture-value" class="simulator-text-value">0</span></label>
                                <input id="moisture-slider" type="range" min="0" max="100" value="0" step="1" class="simulator-input-group-range">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8"> {# Replaced lg:col-span-2 #}
                        <div class="simulator-card"> {# Replaced Tailwind classes #}
                            <h3 class="h5 font-weight-bold mb-4">Membership Function Visualization (Fuzzification)</h3>
                            <div class="row g-2"> {# Replaced grid md:grid-cols-3 gap-4 with Bootstrap row and gutter #}
                                <div class="col-md-4"><div class="chart-container"><canvas id="phChart"></canvas></div></div>
                                <div class="col-md-4"><div class="chart-container"><canvas id="tempChart"></canvas></div></div>
                                <div class="col-md-4"><div class="chart-container"><canvas id="moistureChart"></canvas></div></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 py-4"> {# Replaced lg:col-span-3 #}
                        <div class="simulator-card"> {# Replaced Tailwind classes #}
                             <h3 class="h5 font-weight-bold mb-4">Results & Recommendation</h3>
                             <div class="row g-4 align-items-center"> {# Replaced grid md:grid-cols-2 gap-8 items-center #}
                                 <div class="col-md-6">
                                    <h4 class="h6 font-weight-semibold d-none">Active Fuzzy Rules:</h4> {# Replaced text-lg font-semibold #}
                                    <div id="active-rules" class="active-rules-box d-none"> {# Replaced Tailwind classes #}
                                        <p>Slide the sliders to see rules...</p>
                                    </div>
                                    <h4 class="h6 font-weight-semibold mt-4">Defuzzification Process (Centroid):</h4>
                                    <div class="chart-container mt-2"><canvas id="outputChart"></canvas></div>
                                 </div>
                                 <div class="col-md-6">
                                     <div class="recommendation-box"> {# Replaced Tailwind classes #}
                                        <h4 class="h6 font-weight-semibold mb-2">Plant Recommendation:</h4>
                                        <p id="recommendation-output" class="recommendation-output-text">N/A</p>
                                        <p class="text-secondary">with</p> {# Replaced text-gray-600 #}
                                        <h4 class="h6 font-weight-semibold mt-2 mb-1">Suitability Level:</h4>
                                        <p id="confidence-output" class="confidence-output-text">0%</p>
                                     </div>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script defer src="{% static 'solire_app/js/sidebar.js' %}"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // REMOVED: Chart.register(ChartjsPluginAnnotation); to fix ReferenceError

        let data = [];

        const DatabaseTable = new DataTable('#soilConditionsTable', {
            responsive: true,
        });

        const LiveFeedTable = new DataTable('#liveFeedTable', {
            responsive: true,
            searching: false,
            paging: false,
            info: false, // Hide "Showing X of Y entries" for live feed
            data: data, // Pass the data directly
            columns: [
                { data: 'ph_value' },
                { data: 'moisture_value' },
                { data: 'temperature_value' },
                {
                    data: 'timestamps',
                    render: function(data, type, row) {
                        return formatTimestamp(data);
                    }
                }
            ],
            // Order by timestamps, descending, as backend sends newest-first.
            order: [[3, 'desc']] // index 3 for timestamps
        });

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
        }

        function formatRecommendedPlants(raw) {
            if (!raw || typeof raw !== 'string') return '<em>No data</em>';

            const plantRegex = /([\w_]+) \[([\d.]+), (\w+)\]\((.*?)\)/g;
            let match;
            let html = '<ul style="margin: 0; padding-left: 1em;">';
            let hasValidPlant = false;

            while ((match = plantRegex.exec(raw)) !== null) {
                const plant = match[1].replace(/_/g, ' ');
                const score = parseFloat(match[2]);
                const confidence = match[3];
                const status = match[4];

                if (score >= 0.5) {
                    hasValidPlant = true;
                    let statusColor = status.includes('Highly') ? 'green' :
                    status.includes('Moderately') ? 'orange' : 'gray';

                    html += `<li>
                        <strong>${plant}</strong> –
                        Score: <code>${score}</code>,
                        Confidence: <code>${confidence}</code>,
                        Status: <em style="color: ${statusColor};">${status}</em>
                    </li>`;
                }
            }

            html += '</ul>';

            if (!hasValidPlant) {
                return '<em style="color: gray;">No suitable plants (score < 0.5)</em>';
            }

            return html;
        }

        // Get CSRF token from meta tag
        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }

        async function fetchData(url) {
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        async function insertData(url, data) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(), // Include CSRF token
                    },
                    body: data
                });

                const result = await response.json();

                if (response.ok) {
                    console.log('Success:', result);
                    return result;
                } else {
                    console.error('Error:', result);
                    throw new Error(result);
                }
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        async function clearData(url) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(), // Include CSRF token
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    console.log('Success:', result);
                    return result;
                } else {
                    console.error(response.error);
                    throw new Error(result.error); // Throw the error message
                }
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        // Variable to keep track of the MQTT client's connection state
        let mqttConnected = false;
        let mqttClient = null;

        // The MQTT connection logic, extracted into a reusable function
        function connectMqtt() {
            console.log("Attempting to connect to MQTT broker...");
            mqttClient = mqtt.connect(
                "wss://piperbelly008:5wtOnOVrFYnyBP7T@piperbelly008.cloud.shiftr.io",
                {
                    clientId: "SolireWeb",
                }
            );

            mqttClient.on("connect", function () {
                console.log("Connected to MQTT broker!");
                mqttConnected = true;
                mqttClient.subscribe("Sensors");
            });

            mqttClient.on("message", function (topic, message) {
                // Your existing message handling logic goes here
                message = message.toString().replace(/\\/g, "");
                console.log("Received MQTT message:", JSON.parse(message));
                const data = JSON.parse(message); // Parse once

                document.getElementById("realtime_ph").textContent =  data.ph_value;
                document.getElementById("realtime_moisture").textContent =  data.moisture_percent;
                document.getElementById("realtime_temperature").textContent =  data.temperature_c;

                // Format the row data with current timestamp
                const rowData = {
                    ph_value: data.ph_value,
                    moisture_value: data.moisture_percent,
                    temperature_value: data.temperature_c,
                    timestamps: new Date().toISOString()
                };

                // Maintain a static array buffer of last 5 entries
                if (!window.liveFeedBuffer) window.liveFeedBuffer = [];

                // Add new data to the start
                window.liveFeedBuffer.unshift(rowData);

                // Keep only 5 most recent entries
                if (window.liveFeedBuffer.length > 5) {
                    window.liveFeedBuffer.pop(); // remove the oldest one
                }

                // Clear and re-render the LiveFeedTable with latest 5 rows
                LiveFeedTable.clear();
                LiveFeedTable.rows.add(window.liveFeedBuffer);
                LiveFeedTable.draw();

                insertData("{% url 'solire_app:insert_data' %}", JSON.stringify(data))
                    .then(() => {
                        console.log('Data inserted successfully');
                    })
                    .catch(error => {
                        console.error('Error inserting data via MQTT:', error);
                    });
            });

            mqttClient.on("error", function (error) {
                console.error("MQTT error:", error);
                // It's a good practice to handle connection errors and disconnections.
                // The `connectMqtt` function could be called again here after a delay.
            });

            mqttClient.on("close", function() {
              console.log("MQTT connection closed.");
              mqttConnected = false;
              mqttClient = null;
            });
        }

        // Function to disconnect from MQTT
        function disconnectMqtt() {
            if (mqttClient) {
                console.log("Disconnecting from MQTT broker...");
                mqttClient.end(true, () => {
                    console.log("Disconnected successfully.");
                    mqttConnected = false;
                    mqttClient = null;
                });
            }
        }

        // Event listener for the keyboard shortcut
        document.addEventListener('keydown', function(event) {
            // Check for Shift, Ctrl, and Backspace keys pressed simultaneously
            if (event.shiftKey && event.ctrlKey && event.key === 'Backspace') {
                event.preventDefault(); // Prevent the default browser action (e.g., navigating back)

                // Toggle the connection state
                if (mqttConnected) {
                    disconnectMqtt();
                    alert('Disconnected successfully!');
                } else {
                    connectMqtt();
                    alert('Connected successfully!');
                }
            }
        });

        // Buttons
        const refreshDatabaseButton = document.getElementById('refreshDatabase');
        const clearDatabaseButton = document.getElementById('clearDatabase');

        refreshDatabaseButton.addEventListener('click', function() {
            fetchData('{% url 'solire_app:list_data_with_recommendation' %}')
                .then(response => {
                    if (response.success && Array.isArray(response.data)) {
                        console.log(response.data);
                        DatabaseTable.clear();
                        response.data.forEach((item, index) => {
                            DatabaseTable.row.add([
                                index + 1, // Use index for numbering
                                item.ph_value,
                                item.moisture_value,
                                item.temperature_value,
                                formatRecommendedPlants(item.recommended_plants),
                                formatTimestamp(item.timestamps),
                            ]);
                        });
                        DatabaseTable.draw();
                    } else {
                        console.error('Initial DatabaseTable data is not an array or success is false:', response);
                    }
                })
                .catch(error => {
                    console.error('Initial fetch error for DatabaseTable:', error);
                });
        });

        clearDatabaseButton.addEventListener('click', function() {
            clearData('{% url 'solire_app:clear_data' %}')
                .then(response => {
                    if (response.success) {
                        DatabaseTable.clear().draw();
                        console.log(response.message);
                    } else {
                        console.error(response.error);
                        alert(`Error clearing data: ${response.error}`); // User feedback
                    }
                })
                .catch(error => {
                    console.error('Clear data error:', error);
                    alert(`Failed to clear data: ${error.message || error}`); // User feedback
                });
        });

        // Initialize database table on page load
        refreshDatabaseButton.click(); // Trigger initial load

        // Fuzzy Simulator
        // --- Fuzzy Logic Simulator Scripts (from interactive-analysis.html) ---
        const phSlider = document.getElementById('ph-slider');
        const tempSlider = document.getElementById('temp-slider');
        const moistureSlider = document.getElementById('moisture-slider');

        const phValue = document.getElementById('ph-value');
        const tempValue = document.getElementById('temp-value');
        const moistureValue = document.getElementById('moisture-value');

        const activeRulesEl = document.getElementById('active-rules');
        const recommendationOutputEl = document.getElementById('recommendation-output');
        const confidenceOutputEl = document.getElementById('confidence-output');

        // Chart.js instances
        let phChart, tempChart, moistureChart, outputChart;

        const chartColors = {
            line: '#6B7A40',
            point: '#4A552A',
            area: 'rgba(74, 85, 42, 0.2)',
            grid: 'rgba(200, 200, 200, 0.2)',
            text: '#374151'
        };

        // Helper function for triangular membership (same as skfuzzy.trimf)
        function trimf(x, a, b, c) {
            if (x <= a || x >= c) {
                return 0;
            } else if (x < b) {
                return (x - a) / (b - a);
            } else { // x >= b
                return (c - x) / (c - b);
            }
        }

        // Helper function for trapezoidal membership (same as skfuzzy.trapmf)
        function trapmf(x, a, b, c, d) {
            if (x <= a || x >= d) {
                return 0;
            } else if (x >= b && x <= c) {
                return 1;
            } else if (x > a && x < b) {
                return (x - a) / (b - a);
            } else { // x > c && x < d
                return (d - x) / (d - c);
            }
        }

        // Fuzzy logic definitions - ALIGNED WITH PYTHON's SKFUZZY DEFINITIONS
        const fuzzyDefs = {
            ph: {
                // pH membership functions (aligned with Python's trapmf/trimf parameters)
                acidic: (x) => trapmf(x, 0, 0, 5.0, 6.5),
                neutral: (x) => trimf(x, 5.5, 6.5, 7.5),
                alkaline: (x) => trapmf(x, 7.0, 8.0, 14, 14),
            },
            temperature: {
                // Temperature membership functions (°C) (aligned with Python's trapmf/trimf parameters)
                cold: (x) => trapmf(x, 0, 0, 18, 23),
                normal: (x) => trimf(x, 20, 26, 32),
                hot: (x) => trapmf(x, 30, 35, 40, 40),
            },
            humidity: {
                // Humidity membership functions (%) (aligned with Python's trapmf/trimf parameters)
                low: (x) => trapmf(x, 0, 0, 45, 60),
                medium: (x) => trimf(x, 50, 70, 85),
                high: (x) => trapmf(x, 80, 90, 100, 100),
            }
        };

        // Output membership functions (Simplified for direct score interpretation in JS)
        // Aligned with Python's output MFs: unsuitable (0,0,0.3), moderate (0.2,0.5,0.8), suitable (0.7,1,1)
        const outputSuitabilityValues = {
            'unsuitable': (0 + 0 + 0.4) / 3, // Centroid of trimf [0,0,0.4] is approx 0.133
            'moderate': (0.2 + 0.6 + 0.8) / 3, // Centroid of trimf [0.2,0.6,0.8] is approx 0.533
            'suitable': (0.7 + 1.0 + 1.0) / 3, // Centroid of trimf [0.7,1.0,1.0] is approx 0.9
        };

        // Plant database (from Python's fuzzy_logic.py) - used for names and iterating
        const plantDatabase = {
            'Padi': {'ph': [6.0, 7.0], 'temp': [24, 29], 'humidity': [60, 90]},
            'Jagung': {'ph': [5.6, 6.2], 'temp': [23, 27], 'humidity': [62, 74]},
            'Kedelai': {'ph': [5.8, 7.0], 'temp': [20, 25], 'humidity': [60, 70]},
            'Kacang_Tanah': {'ph': [6.0, 6.5], 'temp': [23, 26.5], 'humidity': [65, 75]},
            'Kacang_Hijau': {'ph': [6.0, 6.5], 'temp': [20, 30], 'humidity': [50, 80]},
            'Ubi_Kayu': {'ph': [4.5, 8.0], 'temp': [24, 30], 'humidity': [60, 65]},
            'Ubi_Jalar': {'ph': [5.5, 8.0], 'temp': [21, 27], 'humidity': [65, 75]}
        };

        // Fuzzy Rules - ALIGNED WITH UPDATED PYTHON's _setup_fuzzy_rules
        // Each rule has a 'cond' function that directly mimics the Python's fuzzy logic combination
        // and a 'desc' for display purposes.
        const fuzzyRules = {
            'Padi': [
                { cond: (ph, temp, hum) => Math.min(fuzzyDefs.ph.neutral(ph), fuzzyDefs.temperature.normal(temp), Math.max(fuzzyDefs.humidity.medium(hum), fuzzyDefs.humidity.high(hum))), suitability: 'suitable', desc: "Ideal PH, Temp, and Medium/High Humidity" },
                { cond: (ph, temp, hum) => Math.min(fuzzyDefs.ph.acidic(ph), fuzzyDefs.temperature.normal(temp)), suitability: 'moderate', desc: "Slightly Acidic PH, Normal Temp, Medium Humidity" },
                { cond: (ph, temp, hum) => Math.max(fuzzyDefs.ph.alkaline(ph), fuzzyDefs.temperature.cold(temp), fuzzyDefs.temperature.hot(temp), fuzzyDefs.humidity.low(hum)), suitability: 'unsuitable', desc: "Alkaline PH OR Cold/Hot Temp OR Low Humidity" }
            ],
            'Jagung': [
                { cond: (ph, temp, hum) => Math.min(Math.max(fuzzyDefs.ph.acidic(ph), fuzzyDefs.ph.neutral(ph)), fuzzyDefs.temperature.normal(temp), fuzzyDefs.humidity.medium(hum)), suitability: 'suitable', desc: "Acidic/Neutral PH, Normal Temp, Medium Humidity" },
                { cond: (ph, temp, hum) => Math.max(fuzzyDefs.ph.alkaline(ph), fuzzyDefs.temperature.cold(temp), fuzzyDefs.temperature.hot(temp), fuzzyDefs.humidity.low(hum), fuzzyDefs.humidity.high(hum)), suitability: 'unsuitable', desc: "Alkaline PH OR Cold/Hot Temp OR Low/High Humidity" }
            ],
            'Kedelai': [
                { cond: (ph, temp, hum) => Math.min(fuzzyDefs.ph.neutral(ph), Math.max(fuzzyDefs.temperature.cold(temp), fuzzyDefs.temperature.normal(temp)), fuzzyDefs.humidity.medium(hum)), suitability: 'suitable', desc: "Ideal PH, Cold/Normal Temp, and Medium Humidity" },
                { cond: (ph, temp, hum) => Math.min(fuzzyDefs.ph.acidic(ph), fuzzyDefs.humidity.medium(hum)), suitability: 'moderate', desc: "Acidic PH, Medium Humidity" },
                { cond: (ph, temp, hum) => Math.max(fuzzyDefs.ph.alkaline(ph), fuzzyDefs.temperature.hot(temp), fuzzyDefs.humidity.low(hum), fuzzyDefs.humidity.high(hum)), suitability: 'unsuitable', desc: "Alkaline PH OR Hot Temp OR Low/High Humidity" }
            ],
            'Kacang_Tanah': [
                { cond: (ph, temp, hum) => Math.min(fuzzyDefs.ph.neutral(ph), fuzzyDefs.temperature.normal(temp), fuzzyDefs.humidity.medium(hum)), suitability: 'suitable', desc: "Ideal PH, Normal Temp, and Medium Humidity" },
                { cond: (ph, temp, hum) => Math.min(fuzzyDefs.ph.acidic(ph), fuzzyDefs.temperature.normal(temp)), suitability: 'moderate', desc: "Acidic PH, Normal Temp" },
                { cond: (ph, temp, hum) => Math.max(fuzzyDefs.ph.alkaline(ph), fuzzyDefs.temperature.cold(temp), fuzzyDefs.temperature.hot(temp), fuzzyDefs.humidity.low(hum), fuzzyDefs.humidity.high(hum)), suitability: 'unsuitable', desc: "Alkaline PH OR Cold/Hot Temp OR Low/High Humidity" }
            ],
            'Kacang_Hijau': [
                { cond: (ph, temp, hum) => Math.min(fuzzyDefs.ph.neutral(ph), Math.max(fuzzyDefs.temperature.normal(temp), fuzzyDefs.temperature.hot(temp)), Math.max(fuzzyDefs.humidity.low(hum), fuzzyDefs.humidity.medium(hum))), suitability: 'suitable', desc: "Ideal PH, Normal/Hot Temp, Low/Medium Humidity" },
                { cond: (ph, temp, hum) => Math.min(fuzzyDefs.ph.acidic(ph), fuzzyDefs.temperature.normal(temp)), suitability: 'moderate', desc: "Acidic PH, Normal Temp" },
                { cond: (ph, temp, hum) => Math.max(fuzzyDefs.ph.alkaline(ph), fuzzyDefs.temperature.cold(temp), fuzzyDefs.humidity.high(hum)), suitability: 'unsuitable', desc: "Alkaline PH OR Cold Temp OR High Humidity" }
            ],
            'Ubi_Kayu': [
                { cond: (ph, temp, hum) => Math.min(Math.max(fuzzyDefs.ph.acidic(ph), fuzzyDefs.ph.neutral(ph), fuzzyDefs.ph.alkaline(ph)), fuzzyDefs.temperature.normal(temp), fuzzyDefs.humidity.medium(hum)), suitability: 'suitable', desc: "Broad PH tolerance, Normal Temp, Medium Humidity" },
                { cond: (ph, temp, hum) => Math.max(fuzzyDefs.temperature.cold(temp), fuzzyDefs.temperature.hot(temp), fuzzyDefs.humidity.low(hum)), suitability: 'unsuitable', desc: "Cold/Hot Temp OR Low Humidity" }
            ],
            'Ubi_Jalar': [
                { cond: (ph, temp, hum) => Math.min(Math.max(fuzzyDefs.ph.neutral(ph), fuzzyDefs.ph.alkaline(ph)), fuzzyDefs.temperature.normal(temp), fuzzyDefs.humidity.medium(hum)), suitability: 'suitable', desc: "Neutral/Alkaline PH, Normal Temp, Medium Humidity" },
                { cond: (ph, temp, hum) => Math.max(fuzzyDefs.ph.acidic(ph), fuzzyDefs.temperature.hot(temp), fuzzyDefs.temperature.cold(temp), fuzzyDefs.humidity.low(hum), fuzzyDefs.humidity.high(hum)), suitability: 'unsuitable', desc: "Acidic PH OR Hot/Cold Temp OR Low/High Humidity" }
            ]
        };

        function updateSimulator() {
            const ph = parseFloat(phSlider.value);
            const temp = parseInt(tempSlider.value);
            const moisture = parseInt(moistureSlider.value);


            phValue.textContent = ph.toFixed(1);
            tempValue.textContent = temp;
            moistureValue.textContent = moisture;

            // Fuzzify inputs (get membership degrees for each term)
            const fuzzyInputMemberships = {
                ph: {
                    acidic: fuzzyDefs.ph.acidic(ph),
                    neutral: fuzzyDefs.ph.neutral(ph),
                    alkaline: fuzzyDefs.ph.alkaline(ph)
                },
                temperature: {
                    cold: fuzzyDefs.temperature.cold(temp),
                    normal: fuzzyDefs.temperature.normal(temp),
                    hot: fuzzyDefs.temperature.hot(temp)
                },
                humidity: {
                    low: fuzzyDefs.humidity.low(moisture),
                    medium: fuzzyDefs.humidity.medium(moisture),
                    high: fuzzyDefs.humidity.high(moisture),
                }
            };

            let activeRulesHTML = '';
            const plantSuitabilityScores = {}; // To store the calculated suitability for each plant

            // Initialize all plant scores to 0
            for (const plantName in plantDatabase) {
                plantSuitabilityScores[plantName] = 0;
            }

            for (const plantName in fuzzyRules) {
                let suitableStrengths = [];
                let moderateStrengths = [];
                let unsuitableStrengths = [];

                fuzzyRules[plantName].forEach(rule => {
                    // Evaluate the condition part of the rule
                    const ruleStrength = rule.cond(ph, temp, moisture);

                    if (ruleStrength > 0) {
                        // Display active rules with their calculated strength
                        activeRulesHTML += `<p><strong>${plantName}</strong> - Rule: "${rule.desc}" (${rule.suitability}): Strength: ${ruleStrength.toFixed(3)}</p>`;


                        // Aggregate outputs for the same plant based on suitability level
                        if (rule.suitability === 'suitable') {
                            suitableStrengths.push(ruleStrength);
                        } else if (rule.suitability === 'moderate') {
                            moderateStrengths.push(ruleStrength);
                        } else if (rule.suitability === 'unsuitable') {
                            unsuitableStrengths.push(ruleStrength);
                        }
                    }
                });

                // --- Aggregation (MAX operator for each output term) ---
                const maxSuitableStrength = suitableStrengths.length > 0 ? Math.max(...suitableStrengths) : 0;
                const maxModerateStrength = moderateStrengths.length > 0 ? Math.max(...moderateStrengths) : 0;
                const maxUnsuitableStrength = unsuitableStrengths.length > 0 ? Math.max(...unsuitableStrengths) : 0;

                // The `outputSuitabilityValues` are effectively the centroids for defuzzification.
                let weightedSum = 0;
                let totalStrength = 0;

                if (maxSuitableStrength > 0) {
                    weightedSum += maxSuitableStrength * outputSuitabilityValues.suitable;
                    totalStrength += maxSuitableStrength;
                }
                if (maxModerateStrength > 0) {
                    weightedSum += maxModerateStrength * outputSuitabilityValues.moderate;
                    totalStrength += maxModerateStrength;
                }
                if (maxUnsuitableStrength > 0) {
                    weightedSum += maxUnsuitableStrength * outputSuitabilityValues.unsuitable;
                    totalStrength += maxUnsuitableStrength;
                }

                let plantOverallSuitability = 0;
                if (totalStrength > 0) {
                    plantOverallSuitability = weightedSum / totalStrength;
                } else {
                    plantOverallSuitability = 0;
                }

                plantSuitabilityScores[plantName] = plantOverallSuitability;
            }

            activeRulesEl.innerHTML = activeRulesHTML || '<p>No rules active for current inputs.</p>';

            // Find the best plant and format output
            let sortedRecommendations = Object.entries(plantSuitabilityScores)
                .map(([plant, score]) => ({ plant, suitability_score: score }))
                .sort((a, b) => b.suitability_score - a.suitability_score); // Sort descending

            let bestPlantName = 'N/A';
            let bestSuitabilityScore = 0;
            let confidenceText = '0%';

            if (sortedRecommendations.length > 0 && sortedRecommendations[0].suitability_score > 0) {
                // Determine top recommendation and its confidence
                const topPlant = sortedRecommendations[0];
                bestPlantName = topPlant.plant;
                bestSuitabilityScore = topPlant.suitability_score;
                confidenceText = `${(bestSuitabilityScore * 100).toFixed(0)}%`;

                // Optionally, adjust confidence text based on score range similar to Python
                if (bestSuitabilityScore >= 0.7) {
                    confidenceOutputEl.style.color = '#22C55E'; // Green-600
                } else if (bestSuitabilityScore >= 0.4) {
                    confidenceOutputEl.style.color = '#F59E0B'; // Amber-500
                } else if (bestSuitabilityScore >= 0.2) {
                    confidenceOutputEl.style.color = '#EF4444'; // Red-500
                } else {
                    confidenceOutputEl.style.color = '#6B7280'; // Gray-500
                }
            } else {
                 confidenceOutputEl.style.color = '#6B7280'; // Gray-500
            }


            recommendationOutputEl.textContent = bestPlantName;
            confidenceOutputEl.textContent = confidenceText;

            // Update Charts
            updateCharts(ph, temp, moisture, fuzzyInputMemberships, plantSuitabilityScores);
        }

        // --- Chart.js related functions (with annotation plugin re-enabled) ---
        function createMembershipChart(ctx, label, xData, yData, inputValue, title, xMin, xMax) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: xData,
                    datasets: yData.map(d => ({ ...d, fill: true, backgroundColor: chartColors.area, borderColor: chartColors.line, borderWidth: 2, pointRadius: 0, tension: 0.1 }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: title, color: chartColors.text },
                        legend: { display: true, position: 'bottom', labels: { boxWidth: 10, font: {size: 10} } },
                        tooltip: { enabled: false }, // Disable default tooltip, annotation handles the marker
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    xMin: inputValue,
                                    xMax: inputValue,
                                    borderColor: 'red',
                                    borderWidth: 2,
                                    label: {
                                        content: `Value: ${inputValue.toFixed(1)}`,
                                        enabled: true,
                                        position: 'top',
                                        font: { size: 10 },
                                        backgroundColor: 'rgba(255, 99, 132, 0.8)',
                                        color: 'white',
                                        yAdjust: -10
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: xMin,
                            max: xMax,
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        },
                        y: {
                            min: 0, max: 1.1,
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        }
                    },
                    animation: { duration: 0 }
                }
            });
        }

        function createOutputChart(ctx, labels, data) {
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Suitability Score',
                        data: data,
                        backgroundColor: (context) => {
                            const value = context.dataset.data[context.dataIndex];
                            if (value >= 0.7) return '#22C55E'; // High suitability (Green)
                            if (value >= 0.4) return '#F59E0B'; // Moderate suitability (Amber)
                            if (value >= 0.2) return '#EF4444'; // Low suitability (Red)
                            return '#9CA3AF'; // Very Low/Unsuitable (Gray)
                        },
                        borderColor: (context) => {
                             const value = context.dataset.data[context.dataIndex];
                            if (value >= 0.7) return '#16A34A';
                            if (value >= 0.4) return '#D97706';
                            if (value >= 0.2) return '#DC2626';
                            return '#6B7280';
                        },
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: false },
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false } // More informative tooltip
                    },
                    scales: {
                         x: {
                            grid: { display: false },
                            ticks: { color: chartColors.text, font: { size: 10 } }
                        },
                        y: {
                            min: 0, max: 1, // Max suitability is 1.0
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        }
                    },
                     animation: { duration: 500 }
                }
            });
        }

        function updateCharts(ph, temp, moisture, fuzzyInputMemberships, plantSuitabilityScores) {
            // Update input charts with current value line and active MFs
            [phChart, tempChart, moistureChart].forEach(chart => {
                let value, membershipSet;
                if (chart.canvas.id === 'phChart') {
                    value = ph;
                    membershipSet = fuzzyInputMemberships.ph;
                } else if (chart.canvas.id === 'tempChart') {
                    value = temp;
                    membershipSet = fuzzyInputMemberships.temperature;
                } else {
                    value = moisture;
                    membershipSet = fuzzyInputMemberships.humidity;
                }

                // Update annotation line position and label
                if (chart.options.plugins.annotation && chart.options.plugins.annotation.annotations && chart.options.plugins.annotation.annotations.line1) {
                    chart.options.plugins.annotation.annotations.line1.xMin = value;
                    chart.options.plugins.annotation.annotations.line1.xMax = value;
                    chart.options.plugins.annotation.annotations.line1.label.content = `Value: ${value.toFixed(1)}`;
                }

                // Highlight membership functions that have a degree > 0
                chart.data.datasets.forEach((dataset) => {
                    // Normalize label to match fuzzyDefs keys (e.g., 'Acidic' -> 'acidic')
                    const term = dataset.label.toLowerCase();
                    const membershipValue = membershipSet[term];

                    if (membershipValue > 0) {
                        dataset.borderColor = 'red';
                        dataset.borderWidth = 3;
                    } else {
                        dataset.borderColor = chartColors.line;
                        dataset.borderWidth = 2;
                    }
                });
                chart.update('none');
            });

            // Update output chart
            if (outputChart) {
                // Ensure labels match the order of data for consistency
                const orderedPlantNames = Object.keys(plantDatabase); // Use actual plant names from the data
                outputChart.data.labels = orderedPlantNames;
                outputChart.data.datasets[0].data = orderedPlantNames.map(name => plantSuitabilityScores[name]);
                outputChart.update();
            }
        }

        function initializeSimulator() {
            // Retrieve min/max from sliders to ensure charts match
            const ph_min = parseFloat(phSlider.min);
            const ph_max = parseFloat(phSlider.max);
            const ph_step = parseFloat(phSlider.step);

            const temp_min = parseFloat(tempSlider.min);
            const temp_max = parseFloat(tempSlider.max);
            const temp_step = parseFloat(tempSlider.step);

            const moisture_min = parseFloat(moistureSlider.min);
            const moisture_max = parseFloat(moistureSlider.max);
            const moisture_step = parseFloat(moistureSlider.step);

            // Generate xData arrays based on actual slider ranges and steps
            const x_ph = Array.from({length: Math.floor((ph_max - ph_min) / ph_step) + 1}, (_, i) => parseFloat((ph_min + i * ph_step).toFixed(1)));
            phChart = createMembershipChart(
                document.getElementById('phChart').getContext('2d'),
                'pH',
                x_ph,
                [
                    { label: 'Acidic', data: x_ph.map(fuzzyDefs.ph.acidic) },
                    { label: 'Neutral', data: x_ph.map(fuzzyDefs.ph.neutral) },
                    { label: 'Alkaline', data: x_ph.map(fuzzyDefs.ph.alkaline) },
                ],
                parseFloat(phSlider.value),
                'Soil pH',
                ph_min,
                ph_max
            );

            const x_temp = Array.from({length: Math.floor((temp_max - temp_min) / temp_step) + 1}, (_, i) => temp_min + i * temp_step);
            tempChart = createMembershipChart(
                document.getElementById('tempChart').getContext('2d'),
                'Temperature',
                x_temp,
                [
                    { label: 'Cold', data: x_temp.map(fuzzyDefs.temperature.cold) },
                    { label: 'Normal', data: x_temp.map(fuzzyDefs.temperature.normal) },
                    { label: 'Hot', data: x_temp.map(fuzzyDefs.temperature.hot) },
                ],
                parseFloat(tempSlider.value),
                'Temperature',
                temp_min,
                temp_max
            );

            const x_moisture = Array.from({length: Math.floor((moisture_max - moisture_min) / moisture_step) + 1}, (_, i) => moisture_min + i * moisture_step);
            moistureChart = createMembershipChart(
                document.getElementById('moistureChart').getContext('2d'),
                'Moisture',
                x_moisture,
                [
                    { label: 'Low', data: x_moisture.map(fuzzyDefs.humidity.low) },
                    { label: 'Medium', data: x_moisture.map(fuzzyDefs.humidity.medium) },
                    { label: 'High', data: x_moisture.map(fuzzyDefs.humidity.high) },
                ],
                parseFloat(moistureSlider.value),
                'Moisture',
                moisture_min,
                moisture_max
            );

            // Initialize output chart with all plant names and zero scores
            const initialPlantScores = {};
            for (const plantName in plantDatabase) { // Use plantDatabase for keys
                initialPlantScores[plantName] = 0;
            }

            outputChart = createOutputChart(
                document.getElementById('outputChart').getContext('2d'),
                Object.keys(plantDatabase),
                Object.values(initialPlantScores)
            );

            // Set initial slider values to 0
            phSlider.value = 0;
            tempSlider.value = 0;
            moistureSlider.value = 0;
            updateSimulator(); // Trigger initial update with default values
        }

        phSlider.addEventListener('input', updateSimulator);
        tempSlider.addEventListener('input', updateSimulator);
        moistureSlider.addEventListener('input', updateSimulator);

        initializeSimulator();
    });
    </script>
</body>
</html>